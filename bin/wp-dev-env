#!/bin/bash
if [ $# -lt 1 ]; then
    echo "Usage: `basename $0` <create|delete> <dir_name>"
    exit 65
fi

CWD=$(pwd)
ACTION=$1
PROJ_NAME=`basename "$CWD"`

if [ -z "$2" ]; then
    DEST_DIR="$CWD/"
else
    DEST_DIR="$CWD/$2"
fi

if [ ! "$DEST_DIR" == "$CWD" ]; then
    if [ -d "$DEST_DIR" ]; then
        echo "$DEST_DIR already exists!"
        exit 1
    else
        mkdir "$DEST_DIR"
    fi
fi

cd "$DEST_DIR"

# Valet link
valet link "$PROJ_NAME"

# Create MySQL db
echo "Creating MySQL database $PROJ_NAME..."
mysql -uroot -e "CREATE DATABASE $PROJ_NAME"

# Install WP
WP_CONF_FILE="$DEST_DIR/wp-config.php"
if [ ! -e "$WP_CONF_FILE" ]; then
    echo "Downloading WP..."
    wp core download

    echo "Configuring and installing WP..."
    wp core config --dbname=$PROJ_NAME --dbuser=root --dbpass='' --extra-php <<PHP
define( 'WP_DEBUG', true );

if ( WP_DEBUG ) {
    @error_reporting( E_ALL );
    @ini_set( 'log_errors', true );

    define( 'WP_DEBUG_LOG', true );
    define( 'WP_DEBUG_DISPLAY', false );
    define( 'SCRIPT_DEBUG', true );
}

function debug_e() {
    var_dump( func_get_args() );
    exit;
}
PHP
    wp core install --url="$PROJ_NAME.test" --title="$PROJ_NAME" --admin_user=admin --admin_password=password --admin_email="admin@$PROJ_NAME.test"

    echo "Installing additional themes and plugins..."
    wp theme install twentytwelve --activate
    wp plugin install query-monitor --activate
fi

